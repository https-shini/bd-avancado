-- =====================================================================
-- PARTE 1: CRIAÇÃO DAS TABELAS (ESTUDO DE CASO: CLÍNICA MÉDICA)
-- Definição da estrutura do banco de dados para o agendamento de consultas.
-- =====================================================================

-- Tabela para armazenar as especialidades dos médicos.
CREATE TABLE tbEspecialidade(
    idEspecialidade NUMBER PRIMARY KEY,
    especialidade VARCHAR2(40),
    -- Coluna para "soft delete": 0 = ativo, 1 = inativo. Preserva o histórico.
    deleted NUMBER(1) DEFAULT 0,
    -- Colunas de auditoria: registram a data de criação e da última alteração.
    data_criacao DATE DEFAULT sysdate,
    data_alteracao DATE DEFAULT sysdate
);

-- Tabela para armazenar os dados dos médicos.
CREATE TABLE tbMedico(
    idMedico NUMBER PRIMARY KEY,
    nomeMedico VARCHAR2(40),
    crmMedico VARCHAR(40),
    idEspecialidade NUMBER,
    deleted NUMBER(1) DEFAULT 0,
    data_criacao DATE DEFAULT sysdate,
    data_alteracao DATE DEFAULT sysdate,
    -- Chave estrangeira que conecta o médico à sua especialidade.
    FOREIGN KEY (idEspecialidade) REFERENCES tbEspecialidade(idEspecialidade)
);

-- Tabela para armazenar os dados dos pacientes.
CREATE TABLE tbPaciente(
    idPaciente NUMBER PRIMARY KEY,
    nomePaciente VARCHAR2(40),
    emailPaciente VARCHAR2(40),
    cpfPaciente VARCHAR2(14),
    deleted NUMBER(1) DEFAULT 0,
    data_criacao DATE DEFAULT sysdate,
    data_alteracao DATE DEFAULT sysdate
);

-- Tabela principal que registra os agendamentos das consultas.
CREATE TABLE tbAgendaConsulta(
    idAgendaConsulta NUMBER PRIMARY KEY,
    idPaciente NUMBER,
    idMedico NUMBER,
    dataConsulta DATE,
    horaConsulta TIMESTAMP,
    deleted NUMBER(1) DEFAULT 0,
    data_criacao DATE DEFAULT sysdate,
    data_alteracao DATE DEFAULT sysdate,
    -- Chaves estrangeiras que conectam a consulta ao paciente e ao médico.
    FOREIGN KEY (idPaciente) REFERENCES tbPaciente(idPaciente),
    FOREIGN KEY (idMedico) REFERENCES tbMedico(idMedico)
);


-- =====================================================================
-- PARTE 2: INSERÇÃO DE DADOS INICIAIS
-- Populando as tabelas com dados de exemplo para os exercícios.
-- =====================================================================

-- Inserindo especialidades
INSERT INTO tbEspecialidade (idEspecialidade, especialidade) VALUES (1, 'Pediatria');
INSERT INTO tbEspecialidade (idEspecialidade, especialidade) VALUES (2, 'Cardiologia');
INSERT INTO tbEspecialidade (idEspecialidade, especialidade) VALUES (3, 'Ortopedia');

-- Inserindo médicos
INSERT INTO tbMedico (idMedico, nomeMedico, crmMedico, idEspecialidade) VALUES (1, 'Dr. Moacir', '11111', 1);
INSERT INTO tbMedico (idMedico, nomeMedico, crmMedico, idEspecialidade) VALUES (2, 'Dra. Ana', '22222', 2);
INSERT INTO tbMedico (idMedico, nomeMedico, crmMedico, idEspecialidade) VALUES (3, 'Dr. Carlos', '33333', 3);


-- Inserindo pacientes
INSERT INTO tbPaciente (idPaciente, nomePaciente, emailPaciente, cpfPaciente) VALUES (1, 'Gabriela', 'gabriela@gmail.com', '111.111.111-11');
INSERT INTO tbPaciente (idPaciente, nomePaciente, emailPaciente, cpfPaciente) VALUES (2, 'Felipe', 'felipe@gmail.com', '222.222.222-22');
INSERT INTO tbPaciente (idPaciente, nomePaciente, emailPaciente, cpfPaciente, deleted) VALUES (3, 'Mariana (Inativa)', 'mariana@gmail.com', '333.333.333-33', 1);


-- Inserindo agendamentos de consulta
-- Consulta futura (manhã)
INSERT INTO tbAgendaConsulta (idAgendaConsulta, idPaciente, idMedico, dataConsulta, horaConsulta)
VALUES (1, 1, 1, TO_DATE('2025-09-15','yyyy-mm-dd'), TO_TIMESTAMP('10:00:00', 'hh24:mi:ss'));
-- Consulta futura (tarde)
INSERT INTO tbAgendaConsulta (idAgendaConsulta, idPaciente, idMedico, dataConsulta, horaConsulta)
VALUES (2, 2, 2, TO_DATE('2025-09-20','yyyy-mm-dd'), TO_TIMESTAMP('15:30:00', 'hh24:mi:ss'));
-- Consulta passada
INSERT INTO tbAgendaConsulta (idAgendaConsulta, idPaciente, idMedico, dataConsulta, horaConsulta)
VALUES (3, 1, 3, TO_DATE('2024-08-10','yyyy-mm-dd'), TO_TIMESTAMP('09:00:00', 'hh24:mi:ss'));
-- Consulta para hoje (manhã)
INSERT INTO tbAgendaConsulta (idAgendaConsulta, idPaciente, idMedico, dataConsulta, horaConsulta)
VALUES (4, 2, 1, TRUNC(SYSDATE), TO_TIMESTAMP('08:30:00', 'hh24:mi:ss'));


-- =====================================================================
-- PARTE 3: EXERCÍCIOS DE VIEWS (RESOLVIDOS)
-- Criação das Views solicitadas na Aula 04.
-- =====================================================================

-- 1. Crie e execute uma view que mostre o nome do médico, o crm e a especialidade.
CREATE OR REPLACE VIEW vw_medico_especialidade AS
SELECT
    m.nomeMedico AS nome_medico,
    m.crmMedico AS crm,
    e.especialidade
FROM
    tbMedico m
INNER JOIN
    tbEspecialidade e ON m.idEspecialidade = e.idEspecialidade;

-- 2. Crie e execute uma view que mostre o nome do paciente, o nome do médico, a especialidade do médico, e a data e hora da consulta.
CREATE OR REPLACE VIEW vw_consulta_paciente AS
SELECT
    p.nomePaciente AS nome_paciente,
    m.nomeMedico AS nome_medico,
    e.especialidade,
    a.dataConsulta AS data_da_consulta,
    a.horaConsulta AS hora_da_consulta
FROM
    tbAgendaConsulta a
INNER JOIN
    tbPaciente p ON a.idPaciente = p.idPaciente
INNER JOIN
    tbMedico m ON a.idMedico = m.idMedico
INNER JOIN
    tbEspecialidade e ON m.idEspecialidade = e.idEspecialidade;

-- 3. Crie e execute uma view que mostre somente os pacientes que não foram "excluídos".
CREATE OR REPLACE VIEW vw_pacientes_ativos AS
SELECT
    idPaciente,
    nomePaciente,
    emailPaciente,
    cpfPaciente
FROM
    tbPaciente
WHERE
    deleted = 0;

-- 4. Crie e execute uma view que traga apenas consultas cuja data seja maior que o dia atual.
CREATE OR REPLACE VIEW vw_consultas_futuras AS
SELECT
    idAgendaConsulta,
    idPaciente,
    idMedico,
    dataConsulta,
    horaConsulta
FROM
    tbAgendaConsulta
WHERE
    dataConsulta > TRUNC(SYSDATE);

-- 5. Crie e execute uma view que exiba o total de pacientes cadastrados.
CREATE OR REPLACE VIEW vw_quantidade_pacientes AS
SELECT
    COUNT(idPaciente) AS total_de_pacientes
FROM
    tbPaciente;

-- 6. Crie e execute uma view que exiba apenas as consultas agendadas na data atual no período entre 8h e 12h.
CREATE OR REPLACE VIEW vw_consultas_manha AS
SELECT
    idAgendaConsulta,
    idPaciente,
    idMedico,
    dataConsulta,
    horaConsulta
FROM
    tbAgendaConsulta
WHERE
    dataConsulta = TRUNC(SYSDATE)
    AND TO_CHAR(horaConsulta, 'HH24') >= '08'
    AND TO_CHAR(horaConsulta, 'HH24') < '12';

-- =====================================================================
-- PARTE 4: EXECUÇÃO E TESTE DAS VIEWS
-- Comandos para visualizar os resultados das Views criadas.
-- =====================================================================

-- Testando a View 1
SELECT * FROM vw_medico_especialidade;

-- Testando a View 2
SELECT * FROM vw_consulta_paciente;

-- Testando a View 3
SELECT * FROM vw_pacientes_ativos;

-- Testando a View 4
SELECT * FROM vw_consultas_futuras;

-- Testando a View 5
SELECT * FROM vw_quantidade_pacientes;

-- Testando a View 6
SELECT * FROM vw_consultas_manha;




